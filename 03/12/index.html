<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>节点磁盘不够用时如何处理 | 交接文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/handover/hero.svg">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/handover/assets/css/0.styles.f8d78339.css" as="style"><link rel="preload" href="/handover/assets/js/app.0bd4e087.js" as="script"><link rel="preload" href="/handover/assets/js/2.40eece3a.js" as="script"><link rel="preload" href="/handover/assets/js/20.3ea0f030.js" as="script"><link rel="prefetch" href="/handover/assets/js/10.272653f1.js"><link rel="prefetch" href="/handover/assets/js/11.742c26f2.js"><link rel="prefetch" href="/handover/assets/js/12.18bc48d7.js"><link rel="prefetch" href="/handover/assets/js/13.c69daf34.js"><link rel="prefetch" href="/handover/assets/js/14.f032ed61.js"><link rel="prefetch" href="/handover/assets/js/15.62f784ac.js"><link rel="prefetch" href="/handover/assets/js/16.eb5b5be5.js"><link rel="prefetch" href="/handover/assets/js/17.f8650417.js"><link rel="prefetch" href="/handover/assets/js/18.dfedbf20.js"><link rel="prefetch" href="/handover/assets/js/19.f7e0f19b.js"><link rel="prefetch" href="/handover/assets/js/21.6b415d81.js"><link rel="prefetch" href="/handover/assets/js/22.fe44f683.js"><link rel="prefetch" href="/handover/assets/js/23.35da1f9e.js"><link rel="prefetch" href="/handover/assets/js/24.e4da81e8.js"><link rel="prefetch" href="/handover/assets/js/25.53623594.js"><link rel="prefetch" href="/handover/assets/js/26.27a315c6.js"><link rel="prefetch" href="/handover/assets/js/27.2c96ed45.js"><link rel="prefetch" href="/handover/assets/js/28.7e031f1e.js"><link rel="prefetch" href="/handover/assets/js/29.e8295554.js"><link rel="prefetch" href="/handover/assets/js/3.dd08ab77.js"><link rel="prefetch" href="/handover/assets/js/30.7ea85f4b.js"><link rel="prefetch" href="/handover/assets/js/31.40c66dac.js"><link rel="prefetch" href="/handover/assets/js/32.94771c91.js"><link rel="prefetch" href="/handover/assets/js/33.baa8703b.js"><link rel="prefetch" href="/handover/assets/js/34.2fbd4503.js"><link rel="prefetch" href="/handover/assets/js/35.49bb5a1f.js"><link rel="prefetch" href="/handover/assets/js/36.ca6640bf.js"><link rel="prefetch" href="/handover/assets/js/37.dc0cb2f1.js"><link rel="prefetch" href="/handover/assets/js/4.a98ae983.js"><link rel="prefetch" href="/handover/assets/js/5.3222be7e.js"><link rel="prefetch" href="/handover/assets/js/6.2f528cd8.js"><link rel="prefetch" href="/handover/assets/js/7.e7c21d4d.js"><link rel="prefetch" href="/handover/assets/js/8.dac3de63.js"><link rel="prefetch" href="/handover/assets/js/9.50eac6c0.js">
    <link rel="stylesheet" href="/handover/assets/css/0.styles.f8d78339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/handover/" class="home-link router-link-active"><!----> <span class="site-name">交接文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/handover/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/handover/01/" class="nav-link">
  服务器相关
</a></div><div class="nav-item"><a href="/handover/02/" class="nav-link">
  代码相关
</a></div><div class="nav-item"><a href="/handover/03/" class="nav-link router-link-active">
  运维相关
</a></div><div class="nav-item"><a href="/handover/04/" class="nav-link">
  其他
</a></div> <a href="https://github.com/strugglingbird/handover" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/handover/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/handover/01/" class="nav-link">
  服务器相关
</a></div><div class="nav-item"><a href="/handover/02/" class="nav-link">
  代码相关
</a></div><div class="nav-item"><a href="/handover/03/" class="nav-link router-link-active">
  运维相关
</a></div><div class="nav-item"><a href="/handover/04/" class="nav-link">
  其他
</a></div> <a href="https://github.com/strugglingbird/handover" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>节点磁盘不够用时如何处理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/handover/03/12/#一、清理或迁移docker的存储目录" class="sidebar-link">一、清理或迁移docker的存储目录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/handover/03/12/#查看磁盘使用情况" class="sidebar-link">查看磁盘使用情况</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#停止docker服务" class="sidebar-link">停止docker服务</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#创建新的docker目录并迁移原有数据" class="sidebar-link">创建新的docker目录并迁移原有数据</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#修改存储配置" class="sidebar-link">修改存储配置</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#docker-版本-v17-05-0" class="sidebar-link">Docker 版本 &gt;= v17.05.0</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#重启-docker" class="sidebar-link">重启 Docker</a></li><li class="sidebar-sub-header"><a href="/handover/03/12/#检查" class="sidebar-link">检查</a></li></ul></li><li><a href="/handover/03/12/#二、扩容磁盘" class="sidebar-link">二、扩容磁盘</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="节点磁盘不够用时如何处理"><a href="#节点磁盘不够用时如何处理" class="header-anchor">#</a> 节点磁盘不够用时如何处理</h1> <h2 id="一、清理或迁移docker的存储目录"><a href="#一、清理或迁移docker的存储目录" class="header-anchor">#</a> 一、清理或迁移docker的存储目录</h2> <blockquote><p>docker用起来简单，但是要用到实际线上业务当中细节问题往往影响整个系统的稳定，比如docker容器在物理机上的数据卷问题。docker默认的根目录是/var/lib/docker，容器使用一段时间后会发现该目录所占磁盘会非常大，小到几个G，大到上百G，而/var/lib/docker所在的分区往往不大，此时就需要将该目录迁移到一个物理空间比较大的分区中，并修改docker的默认根目录。</p></blockquote> <p>具体步骤如下：</p> <h3 id="查看磁盘使用情况"><a href="#查看磁盘使用情况" class="header-anchor">#</a> 查看磁盘使用情况</h3> <p>查看磁盘使用情况</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@rancher-node2 ~<span class="token punctuation">]</span><span class="token comment"># du -hs /var/lib/docker/</span>
47G	/var/lib/docker/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看Docker的磁盘使用情况</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@rancher-node2 ~<span class="token punctuation">]</span><span class="token comment"># docker system df</span>
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          <span class="token number">32</span>        <span class="token number">9</span>         <span class="token number">8</span>.661GB   <span class="token number">5</span>.789GB <span class="token punctuation">(</span><span class="token number">66</span>%<span class="token punctuation">)</span>
Containers      <span class="token number">16</span>        <span class="token number">12</span>        <span class="token number">181</span>.9kB   0B <span class="token punctuation">(</span><span class="token number">0</span>%<span class="token punctuation">)</span>
Local Volumes   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">78</span>.36MB   0B <span class="token punctuation">(</span><span class="token number">0</span>%<span class="token punctuation">)</span>
Build Cache     <span class="token number">0</span>         <span class="token number">0</span>         0B        0B
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="停止docker服务"><a href="#停止docker服务" class="header-anchor">#</a> 停止docker服务</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl stop docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="创建新的docker目录并迁移原有数据"><a href="#创建新的docker目录并迁移原有数据" class="header-anchor">#</a> 创建新的docker目录并迁移原有数据</h3> <p>执行命令df -h,找一个大的磁盘。 我在 /home目录下面建了 /home/docker/lib目录，执行的命令是：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /home/docker/lib
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>迁移/var/lib/docker目录下面的文件到 /home/docker/lib：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cp</span> -r /var/lib/docker /home/docker/lib/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="修改存储配置"><a href="#修改存储配置" class="header-anchor">#</a> 修改存储配置</h3> <h3 id="docker-版本-v17-05-0"><a href="#docker-版本-v17-05-0" class="header-anchor">#</a> Docker 版本 &gt;= v17.05.0</h3> <p>因为 Docker 官方在这个发行版本就 deprecated 了 <code>graph</code> 这个 feature，所以如果你机器上安装的 Docker 版本 &gt;= v17.05.0，则无法通过在 <code>/etc/default/docker</code> 配置文件中指定 <code>graph</code> 参数来修改 Docker 的默认安装(存储)目录了，具体参见官网文档：<a href="https://link.ld246.com/forward?goto=https%3A%2F%2Fdocs.docker.com%2Fengine%2Fdeprecated%2F%23-g-and---graph-flags-on-dockerd" target="_blank" rel="noopener noreferrer">Docker Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>好在天无绝人之路，新版本的 Docker 还有其他方式可以达到我们修改安装(存储)目录的目的：通过修改(新建)<code>/etc/docker/daemon.json</code>，指定 <code>data-root</code> 参数的值。</p> <p>按如下操作：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> /etc/docker/daemon.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>加入</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;data-root&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/home/docker/lib&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="重启-docker"><a href="#重启-docker" class="header-anchor">#</a> 重启 Docker</h3> <p>最后，重启 Docker 服务：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart docker
<span class="token comment"># or</span>
<span class="token function">sudo</span> <span class="token function">service</span> docker restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="检查"><a href="#检查" class="header-anchor">#</a> 检查</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker info
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Docker Root Dir: /data/docker/lib/docker
执行<code>docker images</code>可以看到之前所有的镜像也全部同步了过来</p> <h2 id="二、扩容磁盘"><a href="#二、扩容磁盘" class="header-anchor">#</a> 二、扩容磁盘</h2> <p>详情请移步参考<a href="/handover/04/13/">CentOS7如何给磁盘扩容</a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/handover/assets/js/app.0bd4e087.js" defer></script><script src="/handover/assets/js/2.40eece3a.js" defer></script><script src="/handover/assets/js/20.3ea0f030.js" defer></script>
  </body>
</html>
